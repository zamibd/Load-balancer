name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # LINT & VALIDATE
  # ============================================================================
  lint:
    name: Lint & Validate Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate Docker Compose
        run: |
          docker compose config --quiet
          echo "âœ… Docker Compose config is valid"

      - name: Validate Dockerfile
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            docker-compose.yml
            monitoring/prometheus/*.yml
            monitoring/grafana/provisioning/**/*.yml
          config_data: |
            extends: relaxed
            rules:
              line-length:
                max: 150

      - name: Validate TOML config
        run: |
          pip install toml
          python -c "import toml; toml.load('routedns/config.toml')"
          echo "âœ… RouteDNS config.toml is valid"

      - name: Validate HAProxy config syntax
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro \
            haproxy:3.3.1-alpine \
            haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg || true
          echo "âœ… HAProxy config syntax check complete"

      - name: Lint Lua scripts
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/haproxy/lua:/lua:ro \
            nickblah/luacheck:latest \
            /lua --no-unused --no-redefined --max-line-length 150 || true
          echo "âœ… Lua linting complete"

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner (config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

  # ============================================================================
  # BUILD
  # ============================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, security]
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/haproxy
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push HAProxy image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Scan built image
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/haproxy:${{ github.ref_name }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # TEST - Integration Tests
  # ============================================================================
  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create test certificates
        run: |
          mkdir -p haproxy/certs
          openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 1 -nodes \
            -subj "/CN=test.dns.routedns.io"
          cat cert.pem key.pem > haproxy/certs/dot.pem
          chmod 600 haproxy/certs/dot.pem

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          VALKEY_PASSWORD=testpassword123
          VALKEY_HOST=valkey
          GF_SECURITY_ADMIN_USER=admin
          GF_SECURITY_ADMIN_PASSWORD=testpassword123
          HAPROXY_STATS_USER=admin
          HAPROXY_STATS_PASSWORD=testpassword123
          EOF

      - name: Start services
        run: |
          docker compose up -d
          echo "â³ Waiting for services to start..."
          sleep 30

      - name: Check service health
        id: health
        run: |
          echo "ðŸ” Checking service health..."
          
          # Check all containers are running
          RUNNING=$(docker compose ps --format json | jq -r 'select(.State == "running")' | wc -l)
          TOTAL=$(docker compose ps --format json | wc -l)
          
          echo "Running: $RUNNING / $TOTAL containers"
          
          # Individual health checks
          echo "--- HAProxy ---"
          docker compose exec -T haproxy haproxy -vv | head -3 || true
          
          echo "--- Valkey ---"
          docker compose exec -T valkey valkey-cli ping || echo "Valkey ping failed"
          
          echo "--- Prometheus ---"
          curl -sf http://localhost:9090/-/healthy && echo "âœ… Prometheus healthy" || echo "âŒ Prometheus unhealthy"
          
          echo "--- Grafana ---"
          curl -sf http://localhost:3000/api/health && echo "âœ… Grafana healthy" || echo "âŒ Grafana unhealthy"

      - name: Run DNS-over-TLS test
        run: |
          echo "ðŸ” Testing DNS-over-TLS endpoint..."
          # Install kdig for DoT testing
          sudo apt-get update && sudo apt-get install -y knot-dnsutils
          
          # Test DoT (may fail with self-signed cert, but tests connectivity)
          kdig +tls +tls-ca= @127.0.0.1 -p 853 google.com A || echo "DoT test complete (self-signed cert expected)"

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "ðŸ“‹ Collecting logs..."
          docker compose logs > docker-logs.txt
          docker compose ps -a

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker-logs.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans
          docker system prune -f

  # ============================================================================
  # HEALTH CHECK - Extended Tests
  # ============================================================================
  health-check:
    name: Extended Health Checks
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create test environment
        run: |
          mkdir -p haproxy/certs
          openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 1 -nodes \
            -subj "/CN=test.dns.routedns.io"
          cat cert.pem key.pem > haproxy/certs/dot.pem
          chmod 600 haproxy/certs/dot.pem
          
          cat > .env << 'EOF'
          VALKEY_PASSWORD=healthcheck123
          VALKEY_HOST=valkey
          GF_SECURITY_ADMIN_USER=admin
          GF_SECURITY_ADMIN_PASSWORD=healthcheck123
          HAPROXY_STATS_USER=admin
          HAPROXY_STATS_PASSWORD=healthcheck123
          EOF

      - name: Start stack
        run: |
          docker compose up -d
          sleep 45

      - name: Comprehensive health checks
        run: |
          #!/bin/bash
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           COMPREHENSIVE HEALTH CHECKS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          CHECKS_PASSED=0
          CHECKS_FAILED=0
          
          check() {
            local name=$1
            local cmd=$2
            echo -n "Testing $name... "
            if eval "$cmd" > /dev/null 2>&1; then
              echo "âœ… PASS"
              ((CHECKS_PASSED++))
            else
              echo "âŒ FAIL"
              ((CHECKS_FAILED++))
            fi
          }
          
          # Container health
          check "HAProxy container" "docker compose ps haproxy | grep -q 'running'"
          check "RouteDNS container" "docker compose ps routedns | grep -q 'running'"
          check "Valkey container" "docker compose ps valkey | grep -q 'running'"
          check "Prometheus container" "docker compose ps prometheus | grep -q 'running'"
          check "Grafana container" "docker compose ps grafana | grep -q 'running'"
          
          # Service endpoints
          check "Prometheus API" "curl -sf http://localhost:9090/-/healthy"
          check "Grafana API" "curl -sf http://localhost:3000/api/health"
          check "HAProxy stats port" "nc -z localhost 8404"
          check "DoT port 853" "nc -z localhost 853"
          
          # Metrics endpoints
          check "Prometheus targets" "curl -sf http://localhost:9090/api/v1/targets | grep -q 'activeTargets'"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Results: $CHECKS_PASSED passed, $CHECKS_FAILED failed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ $CHECKS_FAILED -gt 0 ]; then
            exit 1
          fi

      - name: Performance baseline test
        run: |
          echo "ðŸ“Š Running performance baseline..."
          
          # Memory usage
          echo "Memory usage per container:"
          docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}\t{{.MemPerc}}"
          
          # Response time check
          echo ""
          echo "Response times:"
          time curl -sf http://localhost:9090/-/healthy > /dev/null
          time curl -sf http://localhost:3000/api/health > /dev/null

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans
          docker system prune -af
          docker volume prune -f

  # ============================================================================
  # DEPLOY (only on main branch)
  # ============================================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build, test, health-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://dns.routedns.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Deploy notification
        run: |
          echo "ðŸš€ Deployment triggered for commit ${{ github.sha }}"
          echo "Image: ${{ needs.build.outputs.image-tag }}"
          echo "Digest: ${{ needs.build.outputs.image-digest }}"
          
          # Add your deployment commands here
          # Examples:
          # - SSH to server and pull new images
          # - Update Kubernetes manifests
          # - Trigger webhook to deployment service

      - name: Create deployment record
        run: |
          echo "Deployed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deployments.log
          echo "Commit: ${{ github.sha }}" >> deployments.log
          echo "---" >> deployments.log

  # ============================================================================
  # CLEANUP - Scheduled cleanup of old resources
  # ============================================================================
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: [test, health-check]
    if: always()
    steps:
      - name: Clean up old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10

      - name: Summary
        run: |
          echo "## ðŸŽ‰ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
